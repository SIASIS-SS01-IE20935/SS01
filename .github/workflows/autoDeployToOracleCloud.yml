name: Auto Deploy to Oracle Cloud

on:
  push:
    branches: [ master ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          echo "ğŸ”‘ Configurando clave SSH para acceso a servidor..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SS01_ORACLE_CLOUD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          
          # Agregar servidor a known_hosts para evitar prompt de verificaciÃ³n
          ssh-keyscan -H ${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }} >> ~/.ssh/known_hosts
          
          echo "âœ… Clave SSH configurada correctamente"

      - name: Deploy to Oracle Cloud Server
        run: |
          echo "ğŸš€ Iniciando deploy en servidor Oracle Cloud..."
          echo "ğŸ“ Servidor: ${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }}"
          echo "ğŸ‘¤ Usuario: ${{ secrets.SS01_ORACLE_CLOUD_USERNAME }}"
          echo "ğŸ“‚ Ruta del proyecto: ${{ secrets.SS01_ORACLE_CLOUD_UBUNTU_PROYECT_PATH }}"
          
          ssh -o StrictHostKeyChecking=no ${{ secrets.SS01_ORACLE_CLOUD_USERNAME }}@${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }} << 'EOF'
            echo "ğŸ” Accediendo al directorio del proyecto..."
            cd ${{ secrets.SS01_ORACLE_CLOUD_UBUNTU_PROYECT_PATH }}
            
            echo "ğŸ“‚ Verificando directorio actual:"
            pwd
            ls -la
            
            echo "ğŸ”„ Actualizando cÃ³digo desde repositorio..."
            git pull origin master
            
            echo "ğŸ“¦ Instalando/actualizando dependencias..."
            npm install --production
            
            echo "ğŸ—ï¸ Compilando proyecto TypeScript..."
            npm run build
            
            echo "ğŸ”„ Reiniciando servicio PM2..."
            sudo pm2 restart siasis-https || sudo pm2 start dist/index.js --name siasis-https
            
            echo "ğŸ“Š Verificando estado del servicio..."
            sudo pm2 status
            sudo pm2 logs siasis-https --lines 5 --nostream
            
            echo "âœ… Deploy completado exitosamente!"
          EOF

      - name: Verify Deployment
        run: |
          echo "ğŸ” Verificando que el servidor estÃ© respondiendo..."
          
          # Esperar unos segundos para que el servicio se inicie completamente
          sleep 15
          
          # Construir URL basÃ¡ndose en variables de entorno
          SERVER_URL="https://${{ secrets.SS01_ORACLE_CLOUD_DOMAIN }}"
          echo "ğŸŒ Verificando: $SERVER_URL"
          
          # Verificar que el servidor responde
          response=$(curl -s -o /dev/null -w "%{http_code}" "$SERVER_URL" --max-time 30 || echo "000")
          
          if [ "$response" = "200" ]; then
            echo "âœ… Servidor responde correctamente (HTTP $response)"
            echo "ğŸŒ Sitio accesible en: $SERVER_URL"
            echo "ğŸ‰ Deploy exitoso!"
          else
            echo "âš ï¸ Servidor no responde como se esperaba (HTTP $response)"
            echo "ğŸ” Verificando logs del servidor..."
            
            # Conectar y obtener logs si hay problemas
            ssh -o StrictHostKeyChecking=no ${{ secrets.SS01_ORACLE_CLOUD_USERNAME }}@${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }} << 'EOF'
              echo "ğŸ“‹ Ãšltimos logs de PM2:"
              cd ${{ secrets.SS01_ORACLE_CLOUD_UBUNTU_PROYECT_PATH }}
              sudo pm2 logs siasis-https --lines 15 --nostream
              
              echo "ğŸ” Estado de PM2:"
              sudo pm2 status
              
              echo "ğŸŒ Verificando puerto 443:"
              sudo ss -tlnp | grep :443
              
              echo "ğŸ” Verificando proceso Node.js:"
              ps aux | grep node
            EOF
            
            # Marcar como fallo pero no detener el workflow
            exit 1
          fi

      - name: Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š RESUMEN DEL DEPLOYMENT"
          echo "=========================="
          echo "ğŸ·ï¸ Repositorio: ${{ github.repository }}"
          echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "â° Tiempo: $(date)"
          echo "ğŸ“ Servidor: ${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }}"
          echo "ğŸ“‚ Ruta: ${{ secrets.SS01_ORACLE_CLOUD_UBUNTU_PROYECT_PATH }}"
          echo "ğŸŒ URL: https://${{ secrets.SS01_ORACLE_CLOUD_DOMAIN }}"
          echo "=========================="