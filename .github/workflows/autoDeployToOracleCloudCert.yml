name: Auto Deploy to Oracle Cloud CERT IE20935

on:
  push:
    branches: [master]

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Solo ejecutar si el entorno es CERTIFICACIÃ“N
    if: ${{ vars.ENTORNO == 'C' }}

    steps:
      - name: Validate Environment
        run: |
          echo "ğŸ” Validando entorno de deployment..."
          if [ "${{ vars.ENTORNO }}" != "C" ]; then
            echo "âŒ Este workflow solo debe ejecutarse en ambiente CERTIFICACIÃ“N (C)"
            echo "ğŸ·ï¸ Entorno detectado: ${{ vars.ENTORNO }}"
            exit 1
          fi
          echo "âœ… Entorno CERTIFICACIÃ“N validado correctamente"

      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup SSH Key
        run: |
          echo "ğŸ”‘ Configurando clave SSH para acceso a servidor CERTIFICACIÃ“N..."
          mkdir -p ~/.ssh
          echo "${{ secrets.SS01_ORACLE_CLOUD_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

          # Agregar servidor a known_hosts para evitar prompt de verificaciÃ³n
          ssh-keyscan -H ${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }} >> ~/.ssh/known_hosts

          echo "âœ… Clave SSH configurada correctamente"

      - name: Deploy to Oracle Cloud CERT Server
        run: |
          echo "ğŸš€ Iniciando deploy en servidor Oracle Cloud CERTIFICACIÃ“N..."
          echo "ğŸ·ï¸ Entorno: CERTIFICACIÃ“N (C)"
          echo "ğŸ“ Servidor: ${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }}"
          echo "ğŸ‘¤ Usuario: ${{ secrets.SS01_ORACLE_CLOUD_USERNAME }}"
          echo "ğŸ“‚ Ruta del proyecto: ${{ secrets.SS01_ORACLE_CLOUD_UBUNTU_PROYECT_PATH }}"
          echo "âš ï¸ PRECAUCIÃ“N: Instancia compartida con DESARROLLO - Deploy solo de CERT"

          ssh -o StrictHostKeyChecking=no ${{ secrets.SS01_ORACLE_CLOUD_USERNAME }}@${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }} << 'EOF'
            echo "ğŸ” Accediendo al directorio del proyecto CERTIFICACIÃ“N..."
            cd ${{ secrets.SS01_ORACLE_CLOUD_UBUNTU_PROYECT_PATH }}
            
            echo "ğŸ“‚ Verificando directorio actual:"
            pwd
            ls -la
            
            echo "ğŸ”„ Actualizando cÃ³digo desde repositorio (FORZANDO cambios del repo)..."
            
            # Preservar carpetas importantes antes de limpiar
            echo "ğŸ’¾ Preservando carpetas crÃ­ticas..."
            mkdir -p /tmp/siasis-backup
            if [ -d "logs" ]; then
              cp -r logs /tmp/siasis-backup/ 2>/dev/null || true
              echo "ğŸ“ Logs respaldados"
            fi
            if [ -d "node_modules" ]; then
              cp -r node_modules /tmp/siasis-backup/ 2>/dev/null || true
              echo "ğŸ“¦ Node_modules respaldado"
            fi
            
            # Limpiar cambios locales (excluyendo carpetas crÃ­ticas)
            echo "ğŸ§¹ Limpiando cambios locales..."
            git reset --hard HEAD
            
            # Limpiar archivos no rastreados EXCEPTO logs y node_modules
            git clean -fd -e logs/ -e node_modules/
            
            # Restaurar carpetas crÃ­ticas
            echo "ğŸ”„ Restaurando carpetas crÃ­ticas..."
            if [ -d "/tmp/siasis-backup/logs" ]; then
              cp -r /tmp/siasis-backup/logs . 2>/dev/null || true
              echo "ğŸ“ Logs restaurados"
            fi
            if [ -d "/tmp/siasis-backup/node_modules" ]; then
              cp -r /tmp/siasis-backup/node_modules . 2>/dev/null || true
              echo "ğŸ“¦ Node_modules restaurado"
            fi
            
            # Crear directorios necesarios si no existen
            mkdir -p logs
            
            # Obtener los Ãºltimos cambios del repositorio
            echo "ğŸ“¥ Descargando cambios del repositorio..."
            git fetch origin master
            
            # Forzar que se use la versiÃ³n del repositorio (descartar cambios locales)
            echo "ğŸ”€ Aplicando cambios del repositorio (descartando cambios locales)..."
            git reset --hard origin/master
            
            echo "âœ… CÃ³digo actualizado exitosamente desde el repositorio"
            echo "ğŸ“Š Estado actual del repositorio:"
            git log --oneline -5
            
            echo "ğŸ“¦ Instalando/actualizando dependencias..."
            npm ci
            
            echo "ğŸ“¦ Instalando dependencias de desarrollo para compilaciÃ³n..."
            npm install --save-dev @types/jsonwebtoken @types/node @types/express @types/cors
            
            echo "ğŸ—ï¸ Intentando compilar proyecto TypeScript..."
            if npm run build; then
              echo "âœ… CompilaciÃ³n exitosa"
            else
              echo "âš ï¸ Error en compilaciÃ³n TypeScript - Continuando con archivos existentes en dist/"
              echo "ğŸ“‹ Verificando si existe directorio dist..."
              if [ ! -d "dist" ]; then
                echo "âŒ No existe directorio dist - No se puede continuar"
                exit 1
              fi
              echo "âœ… Directorio dist encontrado - Usando compilaciÃ³n anterior"
            fi
            
            echo "ğŸ”„ Limpiando estado de PM2 antes de reiniciar..."
            # Limpiar cualquier proceso corrupto de PM2
            pm2 kill 2>/dev/null || true
            sleep 2
            pm2 resurrect 2>/dev/null || true
            
            echo "ğŸ”„ Iniciando servicio PM2 CERTIFICACIÃ“N..."
            # Usar start en lugar de restart para evitar problemas con IDs corruptos
            pm2 start ecosystem.config.js --only siasis-cert
            
            # Verificar que se iniciÃ³ correctamente
            sleep 3
            if pm2 list | grep -q "siasis-cert.*online"; then
              echo "âœ… siasis-cert iniciado correctamente"
            else
              echo "âš ï¸ Problemas al iniciar siasis-cert, reintentando con mÃ©todo alternativo..."
              pm2 delete siasis-cert 2>/dev/null || true
              pm2 start ecosystem.config.js --only siasis-cert
              sleep 3
              if pm2 list | grep -q "siasis-cert.*online"; then
                echo "âœ… siasis-cert iniciado correctamente en segundo intento"
              else
                echo "âŒ No se pudo iniciar siasis-cert - revisar configuraciÃ³n"
              fi
            fi
            
            echo "ğŸ“Š Verificando estado de AMBOS servicios..."
            pm2 status
            
            echo "âœ… Logs especÃ­ficos de CERTIFICACIÃ“N:"
            pm2 logs siasis-cert --lines 5 --nostream 2>/dev/null || echo "âš ï¸ No hay logs disponibles aÃºn"
            
            echo "ğŸ› ï¸ Verificando que DESARROLLO sigue funcionando..."
            if pm2 list | grep -q "siasis-dev.*online"; then
              echo "âœ… DESARROLLO sigue corriendo correctamente"
            else
              echo "âš ï¸ DESARROLLO podrÃ­a estar afectado - verificar manualmente"
            fi
            
            # Limpiar respaldo temporal
            rm -rf /tmp/siasis-backup 2>/dev/null || true
            
            echo "âœ… Deploy CERTIFICACIÃ“N completado exitosamente!"
          EOF

      - name: Verify CERT Deployment
        run: |
          echo "ğŸ” Verificando que el servidor CERTIFICACIÃ“N estÃ© respondiendo..."

          # Esperar mÃ¡s tiempo para que el servicio se inicie completamente
          sleep 20

          # Construir URL basÃ¡ndose en variables de entorno para CERT
          SERVER_URL="https://${{ secrets.SS01_ORACLE_CLOUD_DOMAIN }}/cert"
          echo "ğŸŒ Verificando CERTIFICACIÃ“N: $SERVER_URL"

          # Verificar que el servidor responde
          response=$(curl -s -o /dev/null -w "%{http_code}" "$SERVER_URL" --max-time 30 || echo "000")

          if [ "$response" = "200" ]; then
            echo "âœ… Servidor CERTIFICACIÃ“N responde correctamente (HTTP $response)"
            echo "ğŸŒ Sitio CERTIFICACIÃ“N accesible en: $SERVER_URL"
            
            # Verificar tambiÃ©n que DEV sigue funcionando
            DEV_URL="https://${{ secrets.SS01_ORACLE_CLOUD_DOMAIN }}/dev"
            dev_response=$(curl -s -o /dev/null -w "%{http_code}" "$DEV_URL" --max-time 15 || echo "000")
            
            if [ "$dev_response" = "200" ]; then
              echo "âœ… DESARROLLO tambiÃ©n responde correctamente (HTTP $dev_response)"
              echo "ğŸ‰ Deploy CERTIFICACIÃ“N exitoso SIN afectar DESARROLLO!"
            else
              echo "âš ï¸ DESARROLLO no responde (HTTP $dev_response) - podrÃ­a estar afectado"
            fi
          else
            echo "âš ï¸ Servidor CERTIFICACIÃ“N no responde como se esperaba (HTTP $response)"
            echo "ğŸ” Obteniendo logs del servidor CERTIFICACIÃ“N para diagnÃ³stico..."
            
            # Crear script temporal para obtener logs
            ssh -o StrictHostKeyChecking=no ${{ secrets.SS01_ORACLE_CLOUD_USERNAME }}@${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }} '
              echo "ğŸ“‹ Ãšltimos logs de PM2 CERTIFICACIÃ“N:"
              cd '"${{ secrets.SS01_ORACLE_CLOUD_UBUNTU_PROYECT_PATH }}"'
              pm2 logs siasis-cert --lines 15 --nostream 2>/dev/null || echo "âš ï¸ No hay logs de siasis-cert disponibles"
              
              echo "ğŸ” Estado completo de PM2 (DEV + CERT):"
              pm2 status
              
              echo "ğŸŒ Verificando puerto 5001 (CERT):"
              sudo ss -tlnp | grep :5001 || echo "âš ï¸ Puerto 5001 no estÃ¡ en uso"
              
              echo "ğŸŒ Verificando puerto 5000 (DEV):"
              sudo ss -tlnp | grep :5000 || echo "âš ï¸ Puerto 5000 no estÃ¡ en uso"
              
              echo "ğŸŒ Verificando puerto 443 (Nginx):"
              sudo ss -tlnp | grep :443 || echo "âš ï¸ Puerto 443 no estÃ¡ en uso"
              
              echo "ğŸ” Estado de Nginx:"
              sudo systemctl status nginx --no-pager
              
              echo "ğŸ” Verificando procesos Node.js:"
              ps aux | grep node | grep -v grep || echo "âš ï¸ No se encontraron procesos Node.js"
              
              echo "ğŸ” Verificando estructura del proyecto:"
              ls -la dist/ 2>/dev/null || echo "âš ï¸ No existe directorio dist/"
              
              echo "ğŸ” Verificando ecosystem.config.js:"
              cat ecosystem.config.js 2>/dev/null || echo "âš ï¸ No se puede leer ecosystem.config.js"
            '
            
            echo "â„¹ï¸ Deploy CERTIFICACIÃ“N completado pero verificaciÃ³n fallÃ³ - revisar logs arriba"
          fi

      - name: CERT Deployment Summary
        if: always()
        run: |
          echo "ğŸ“Š RESUMEN DEL DEPLOYMENT CERTIFICACIÃ“N"
          echo "======================================"
          echo "ğŸ·ï¸ Entorno: CERTIFICACIÃ“N (C)"
          echo "ğŸ·ï¸ Repositorio: ${{ github.repository }}"
          echo "ğŸŒ¿ Rama: ${{ github.ref_name }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"
          echo "ğŸ‘¤ Autor: ${{ github.actor }}"
          echo "â° Tiempo: $(date)"
          echo "ğŸ“ Servidor: ${{ secrets.SS01_ORACLE_CLOUD_SERVER_IP }} (Compartido con DEV)"
          echo "ğŸ“‚ Ruta: ${{ secrets.SS01_ORACLE_CLOUD_UBUNTU_PROYECT_PATH }}"
          echo "ğŸŒ URL CERT: https://${{ secrets.SS01_ORACLE_CLOUD_DOMAIN }}/cert"
          echo "ğŸ”— URL DEV: https://${{ secrets.SS01_ORACLE_CLOUD_DOMAIN }}/dev"
          echo "âœ… Proceso PM2: siasis-cert"
          echo "ğŸ”— Puerto interno: 5001"
          echo "âš ï¸ NOTA: Instancia compartida - DEV no debe verse afectado"
          echo "âš ï¸ NOTA: Cambios locales del servidor son DESCARTADOS por el deploy"
          echo "ğŸ”§ MEJORAS: PreservaciÃ³n de logs, manejo de errores TS, limpieza PM2"
          echo "======================================"
